using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Security.Cryptography;
using System.IO;

namespace C_Malware_Scanner
{
    class md5scanner
    {
        private bool checkMD5(string mMd5)
        {
            //if the specified MD5 matches the set string then return the boolean of true, if not return false
            if (mMd5 == "E5D0DB438380E76B4D5531C978B8BAE4")
            {
                return true;
            }
            return false;
        }
        //the code below creates a function called createMD5ForFilesInDir, this function loops through each folder in a given directory and 
        //generates an MD5 for each file, the MD5 is then passed to the checkMD5 function which compares the MD5 to the hard coded MD5 sum
        //if the checkMD5 function returns true, the MD5 is added to the list on Form1
        //if it is false it simply moves on to the next file
        //The code for looping through each file came from the link below:
        //http://stackoverflow.com/questions/929276/how-to-recursively-list-all-the-files-in-a-directory-in-c
        //And the idea for the code which generates the MD5 sum for each file came from the link below:
        //http://stackoverflow.com/questions/10520048/calculate-md5-checksum-for-a-file
        public void createMD5ForFilesInDir(string dir, Form1 form, string virDB)
        {
            foreach (string filestream in System.IO.Directory.GetFiles(dir))
            {
                try
                {
                    var md5 = MD5.Create();
                    var file = System.IO.File.OpenRead(filestream);
                    string md5check = BitConverter.ToString(md5.ComputeHash(file)).Replace("-", "").ToLower();
                    if (checkMD5(md5check) == true)
                    {
                        form.MD5ScanListBox.Items.Add(md5check);
                    }
                    
                    md5.Dispose();
                }
                catch (System.UnauthorizedAccessException e)
                {
                    //Could not access file
                }
                foreach (string d in System.IO.Directory.GetDirectories(dir))
                {
                    foreach (string f in System.IO.Directory.GetFiles(d))
                    {
                        try
                        {
                            var md5 = MD5.Create();
                            var file = System.IO.File.OpenRead(f);
                            string md5check = BitConverter.ToString(md5.ComputeHash(file)).Replace("-", "").ToLower();
                            if (checkMD5(md5check) == true)
                            {
                                form.MD5ScanListBox.Items.Add(f);
                            }
                            
                            md5.Dispose();
                        }
                        catch (System.UnauthorizedAccessException e)
                        {
                            //Could not access file
                        }
                    }
                }

            }
        }
    }
}

