using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Security.Cryptography;
using System.IO;

namespace C_Malware_Scanner
{
    class md5scanner
    {
        private bool checkMD5(string mMd5, string virDB)
        {
            int counter = 0;
            string line;

            // Read the file and display it line by line.
            System.IO.StreamReader file =
               new System.IO.StreamReader(virDB);
            while ((line = file.ReadLine()) != null)
            {
                counter++;
                if (line == mMd5)
                {
                    
                    Console.WriteLine(line);
                    return true;
                    
                }
                else if(line == "[Process]") 
                {
                    break;
                    
                }
                else
                {
                    
                    Console.WriteLine(line);
                    return false;
                }
                
            }

            file.Close();

            // Suspend the screen.
            Console.ReadLine();
            return false;
        }
        public void createMD5ForFilesInDir(string dir, Form1 form, string virDB)
        {
            foreach (string filestream in System.IO.Directory.GetFiles(dir))
            {
                try
                {
                    var md5 = MD5.Create();
                    var file = System.IO.File.OpenRead(filestream);
                    string md5check = BitConverter.ToString(md5.ComputeHash(file)).Replace("-", "").ToLower();
                    if (checkMD5(md5check, virDB) == true)
                    {
                        form.MD5ScanListBox.Items.Add(md5check);
                    }
                    
                    md5.Dispose();
                }
                catch (System.UnauthorizedAccessException e)
                {
                    //Could not access file
                }
                foreach (string d in System.IO.Directory.GetDirectories(dir))
                {
                    foreach (string f in System.IO.Directory.GetFiles(d))
                    {
                        try
                        {
                            var md5 = MD5.Create();
                            var file = System.IO.File.OpenRead(f);
                            string md5check = BitConverter.ToString(md5.ComputeHash(file)).Replace("-", "").ToLower();
                            if (checkMD5(md5check, virDB) == true)
                            {
                                form.MD5ScanListBox.Items.Add(md5check);
                            }
                            
                            md5.Dispose();
                        }
                        catch (System.UnauthorizedAccessException e)
                        {
                            //Could not access file
                        }
                    }
                }

            }
        }
    }
}

